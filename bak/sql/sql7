drop view view_appointment_calendar;
create view view_appointment_calendar as
select a.id, a.customer_id, a.physician_id, a.begin_datetime, a.end_datetime,
       pa.first_name || ' ' || pa.last_name as customer_name,
       ph.first_name || ' ' || ph.last_name as physician_name
from
    appointment a
left join customer pa on pa.id = a.customer_id
left join ab_user ph on ph.id = a.physician_id
;

delete from customer where id > 3;
delete from appointment;
delete from package;
delete from package_ticket;
delete from receipt_item;
delete from receipt;

update package set receipt_no = '-';
delete from receipt where receipt_type='Package';
delete from receipt_item;


select * from package where sharing_mobile1 = '91234567'

;
select * from receipt;
select * from appointment where receipt_no = '00005';
select * from receipt_item;

select * from category is

drop table appointment;
drop table coupon;

drop table category;

drop table customer;
drop table receipt;
drop table receipt_item;
drop table customer_document;
drop table medical_history;
drop table package;
drop table package_ticket;

update category set quantity = 1 where quantity=0;


SELECT anon_1.count_1 AS anon_1_count_1
FROM (
    SELECT count(1) AS count_1 FROM category
        WHERE category.expiry_date > '2019-01-01' AND (category.category_type = 'Services' OR category.category_type = 'Products')
    UNION
    SELECT count(1) AS count_1 FROM category
        WHERE category.expiry_date > '2019-01-01' AND category.id = 16
) AS anon_1;



select * from package where sharing_mobile1='98765432' or
sharing_mobile2='98765432' or
sharing_mobile3='98765432' or
sharing_mobile4='98765432' or
sharing_mobile5='98765432';

update package set ticket_count = 10 where id = 1;

UPDATE patient SET physician1_id=3 WHERE patient.id = 1;



select receipt_date, sum(total) from view_report_receipt
group by receipt_date
having receipt_date >= '2019-09-23' and receipt_date <= '2019-09-24';


drop view view_report_receipt;
create view view_report_receipt as
select
    a.receipt_no, a.receipt_date,
    d.first_name || ' ' || d.last_name as customer_name, d.contact_no, d.hkid, d.date_of_birth,
    a.payment_method, a.payment_reference, b.total
from
    receipt a
left join (
    select receipt_id, sum(amount) as total from (
        select receipt_id, amount from receipt_item where status = 'A'
    ) group by receipt_id
) b
on a.id = b.receipt_id
left join customer d
on a.customer_id = d.id
where a.status = 'A';

select * from receipt;


drop view view_report_receipt_item;

create view view_report_receipt_item as
select
    c.receipt_no, c.receipt_date,
    b.category_type,
    a.description,
    a.apply_coupon,
    c.coupon_code,
    b.original_price,
    a.amount as actual_price
from receipt_item a
left join ( select id, category_type, description, price as original_price from category ) b
on a.category_id = b.id
left join receipt c
on a.receipt_id = c.id
left join coupon e
on c.coupon_code = e.code
where
a.status = 'A' and
c.status = 'A';

drop view view_appointment_calendar;
create view view_appointment_calendar as
select a.id, a.customer_id, a.physician_id, a.begin_datetime, a.end_datetime, a.color_code,
       pa.first_name || ' ' || pa.last_name as customer_name,
       ph.first_name || ' ' || ph.last_name as physician_name
from
    appointment a
left join customer pa on pa.id = a.customer_id
left join ab_user ph on ph.id = a.physician_id
;

select * from view_appointment_calendar;

select * from appointment order by created_on;


select count(*) from appointment
where
    facilities_booking = 'Yes' and
    created_on < (select created_on from appointment where id = 3) and
    (begin_datetime between (select begin_datetime from appointment where id = 3) and
                         (select end_datetime from appointment where id = 3)
                         or
    end_datetime between (select begin_datetime from appointment where id = 3) and
                         (select end_datetime from appointment where id = 3))
;

select  from package
where
    ticket_remaining > 0 and (
    sharing_mobile1 = '98765432' or
    sharing_mobile2 = '98765432' or
    sharing_mobile3 = '98765432' or
    sharing_mobile4 = '98765432' or
    sharing_mobile5 = '98765432'
    )
;
select * from category;