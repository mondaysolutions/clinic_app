select 
    a.lesson_schedule_id, a.open_count, l.invoice_lesson_id,
    l.begin_datetime, l.end_datetime, l.lesson_remark, 
    i.student_id, i.student_history_id, i.lesson_year, i.lesson_month,
    CASE i.lesson_week
     WHEN 0 THEN 'Monday'
     WHEN 1 THEN 'Tuesday'
     WHEN 2 THEN 'Wednesday'
     WHEN 3 THEN 'Thursday'
     WHEN 4 THEN 'Friday'
     WHEN 5 THEN 'Saturday'
     WHEN 6 THEN 'Sunday'
     END as lesson_week,
    h.instrument_id, h.grade_id, h.teacher_id, s.first_name ||' '|| s.last_name as student_name,
    t.first_name ||' '|| t.last_name as teacher_name,
    instr.name as instrument, g.name as grade
from (
    select 
        lesson_schedule_id, count(lesson_schedule_id) as 'open_count'
    from 
        lesson_actual 
    group by lesson_schedule_id, lesson_status 
    having lesson_status='Open'
) a
left join lesson_schedule l on
    l.id = a.lesson_schedule_id
left join invoice_lesson i on
    i.id = l.invoice_lesson_id
left join student_history h on
    h.id = i.student_history_id
left join student s on
    s.id = h.student_id
left join teacher t on
    t.id = h.teacher_id
left join instrument instr on
    instr.id = h.instrument_id
left join grade g on
    g.id = h.grade_id
    ;
    

select 
    a.lesson_schedule_id, a.lesson_count, l.invoice_lesson_id,
    l.begin_datetime, l.end_datetime, l.lesson_remark, 
    i.student_id, i.student_history_id, i.lesson_year, i.lesson_month,
    CASE i.lesson_week
     WHEN 0 THEN 'Monday'
     WHEN 1 THEN 'Tuesday'
     WHEN 2 THEN 'Wednesday'
     WHEN 3 THEN 'Thursday'
     WHEN 4 THEN 'Friday'
     WHEN 5 THEN 'Saturday'
     WHEN 6 THEN 'Sunday'
     END as lesson_week,
    h.instrument_id, h.teacher_id, s.first_name ||' '|| s.last_name as student_name,
    t.first_name ||' '|| t.last_name as teacher_name,
    instr.name as instrument, g.name as grade
from (
    select 
        lesson_schedule_id, count(lesson_schedule_id) as 'lesson_count'
    from 
        lesson_actual 
    group by lesson_schedule_id, lesson_status
) a
left join lesson_schedule l on
    l.id = a.lesson_schedule_id
left join invoice_lesson i on
    i.id = l.invoice_lesson_id
left join student_history h on
    h.id = i.student_history_id
left join student s on
    s.id = h.student_id
left join teacher t on
    t.id = h.teacher_id
left join instrument instr on
    instr.id = h.instrument_id
left join grade g on
    g.id = h.grade_id
    ;